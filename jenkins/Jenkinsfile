pipeline {
    agent any

    environment {
        REPO_URL = 'https://github.com/5etools-mirror-3/5etools-src.git'
        LOCAL_REPO = '5etools-src'
        IMAGE_NAME = 'inaki/5etools:latest'
        KUBECONFIG = '/var/jenkins_home/.kube/config'

    }



    stages {

        stage('Clonar repositorio') {
            steps {
                sh '''
                    if [ -d "$LOCAL_REPO" ]; then
                        cd $LOCAL_REPO
                    else
                        git clone $REPO_URL
                    fi
                '''
            }
        }
        stage('Construir imagen Docker') {
            steps {
                sh '''
                    cd $LOCAL_REPO
                    mv ../Dockerfile . 
                    docker build -t $IMAGE_NAME .
                '''
            }
        }
        stage('Desplegar en Kubernetes') {
            steps {
                sh '''
                    if [ $(docker ps -a -q -f name=5etools-container) ]; then
                        docker rm -f 5etools-container
                    fi
                        docker run --name 5etools-container -d -p 5050:5050 $IMAGE_NAME
                '''
            }
        }

    }

}
