pipeline {
    agent { 
        docker {
            image 'docker:24.0.5'
            args '--privileged -v /var/run/docker.sock:/var/run/docker.sock'
        }
    }


    environment {
        LOCAL_REPO = '5etools'
        GIT_REPO = 'https://github.com/5etools-mirror-3/5etools-src.git'
        NAME_IMAGE = '5etools-image:latest'
    }

    stages {
        stage('Clonación o Actualización del Repositorio') {
            steps {
                sh '''
                    if [ ! -d "./$LOCAL_REPO" ]; then
                        git clone $GIT_REPO ./$LOCAL_REPO
                        cd ./$LOCAL_REPO
                    else
                        cd ./$LOCAL_REPO
                        git pull origin main
                    fi
                '''
            }
        }

        stage('Construcción del Proyecto') {
            steps {
                sh '''
                    cd $LOCAL_REPO
                    docker build -t $NAME_IMAGE .
                '''
            }
        }

        stage('Deployment con Kubernetes') {
            steps {
                sh '''
                    kubectl set image deployment/5etools-deployment 5etools-container=$NAME_IMAGE --record
                '''
            }
        }
    }
}
