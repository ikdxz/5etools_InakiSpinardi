pipeline {
    agent any

    environment {
        LOCAL_REPO = '5etools-src'
        GIT_REPO = 'https://github.com/5etools-mirror-3/5etools-src.git'
        NAME_IMAGE = '5etools-image:latest'
    }

    stages {
        stage('Clonación o Actualización del Repositorio') {
            steps {
                sh '''
                    if [ ! -d "$LOCAL_REPO" ]; then
                        git clone $GIT_REPO
                        cd $LOCAL_REPO
                    else
                        cd $LOCAL_REPO
                        git pull origin main
                    fi
                '''
            }
        }

        stage('Construcción del Proyecto') {
            steps {
                sh '''
                    cd $LOCAL_REPO
                    mv ../../Dockerfile .
                    docker build -t $NAME_IMAGE .
                '''
            }
        }

        stage('Deployment con Kubernetes') {
            steps {
                sh '''
                    kubectl set image deployment/5etools-deployment 5etools-container=$NAME_IMAGE --record
                '''
            }
        }
    }
}
